<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Cart</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <nav>
            <ul class="tabs">
				<li class="store-name">Channa Stores</li>
                <li><a href="products.html" class="tab">Products</a></li>
                <li><a href="cart.html" class="tab active">Cart</a></li>
                <li><a href="orders.html" class="tab">Orders</a></li>
                <li><a href="profile.html" class="tab">Profile</a></li>
                <li class="signout-tab"><a href="login.html" class="tab">Sign Out</a></li>
            </ul>

        </nav>
    </header>

    <main>
        <h2>Your Cart</h2>

        <!-- Cart Table -->
        <section id="cart-section">
            <table id="cart-table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Total</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamically populated cart items will go here -->
                </tbody>
            </table>
            <p id="total-price">Total: Rs. 0.00</p>
            <button id="checkout-button">Checkout</button>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 Shop Management System</p>
    </footer>

    <script>
        
		
// Fetch cart from localStorage (if it exists) or initialize as an empty array
let cart = JSON.parse(localStorage.getItem('cart')) || [];

// Fetch cart ID from localStorage
let cartId = localStorage.getItem('cartId');

// Fetch cart items from the backend if cartId exists
function fetchCartItems() {
    if (!cartId) {
        console.error('No cart ID found in localStorage');
        alert('Cart ID not found. Please try again later.');
        return;
    }

    fetch(`/api/cart/${cartId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch cart items');
            }
            return response.json();
        })
        .then(data => {
            cart = data; // Update the local cart array with fetched data
            renderCart(); // Render the cart on the page
        })
        .catch(error => {
            console.error('Error fetching cart items:', error);
            alert('Failed to load cart items. Please try again.');
        });
}
//////////////////////////////////////////////////////////////
// Function to create a new cart on the backend and set the cart ID
function createCart() {
    fetch('/api/cart', {
        method: 'POST', // POST request to create a new cart
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to create cart');
        }
        return response.json();
    })
    .then(data => {
        cartId = data.cartId; // Save the generated cartId from backend
        localStorage.setItem('cartId', cartId); // Store the cartId in localStorage
        console.log('Cart created with ID:', cartId);
        fetchCartItems(); // Now fetch the cart items after creation
    })
    .catch(error => {
        console.error('Error creating cart:', error);
        alert('Failed to create cart. Please try again.');
    });
}

// Call fetchCartItems on page load to populate the cart
document.addEventListener('DOMContentLoaded', fetchCartItems);

//////////////////////////////////////////////////////////////

// Function to render the cart
function renderCart() {
    const cartTableBody = document.querySelector('#cart-table tbody');
    cartTableBody.innerHTML = '';
    let totalPrice = 0;

    // Render each item in the cart
    cart.forEach(item => {
        const row = document.createElement('tr');
        const totalItemPrice = item.price * item.quantity;
        totalPrice += totalItemPrice;

        row.innerHTML = `
            <td>${item.name}</td>
            <td>
                <input type="number" value="${item.quantity}" min="0" id="quantity-${item.id}" onchange="updateQuantity(${item.id})">
            </td>
            <td>Rs.${item.price.toFixed(2)}</td>
            <td>Rs.${totalItemPrice.toFixed(2)}</td>
            <td><button onclick="removeFromCart(${item.id})">Remove</button></td>
        `;
        cartTableBody.appendChild(row);
    });

    // Update the total price
    document.getElementById('total-price').textContent = `Total: Rs. ${totalPrice.toFixed(2)}`;

    // Save updated cart to localStorage
    localStorage.setItem('cart', JSON.stringify(cart));
}

// Call fetchCartItems on page load to populate the cart
fetchCartItems();

////////////////////////////////////////////////////////////////////////
// Function to add product to the cart
function addToCart(productId, productName, productPrice) {
    // Ensure cart exists, create one if needed
    if (!cartId) {
        console.log('Cart ID not found, creating a new cart...');
        createCart();  // Create cart and then add product
        return;
    }

    const existingProduct = cart.find(item => item.id === productId);

    if (existingProduct) {
        // If product already in cart, update quantity
        existingProduct.quantity += 1;
    } else {
        // Add new product to the cart
        cart.push({ id: productId, name: productName, price: productPrice, quantity: 1 });
    }

    renderCart(); // Update cart view
}

///////////////////////////////////////////////////////////////////////////////////////
// Function to update quantity of a product in the cart
function updateQuantity(productId) {
    const quantityInput = document.getElementById(`quantity-${productId}`);
    const newQuantity = parseInt(quantityInput.value);

    // Validate quantity
    if (isNaN(newQuantity) || newQuantity < 0) {
        alert('Please enter a valid non-negative number for quantity!');
        return;
    }

    // Update the quantity in the local cart
    const product = cart.find(item => item.id === productId);
    if (!product) {
        console.error(`Product with ID ${productId} not found in the cart.`);
        return;
    }
    product.quantity = newQuantity;

    // Update the backend with the new quantity
    updateCartQuantityInBackend(productId, newQuantity);

    // Re-render the cart
    renderCart();
}

// Function to update cart quantity in the backend
function updateCartQuantityInBackend(productId, newQuantity) {
    fetch(`/api/cart/${productId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ quantity: newQuantity })
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Cart updated successfully:', data);
        })
        .catch(error => {
            console.error('Error updating cart:', error);
            alert('Failed to update cart. Please try again!');
        });
}
/////////////////////////////////////////////////////////////////////////////////
// Function to remove a product from the cart
function removeFromCart(productId) {
    const productIndex = cart.findIndex(item => item.id === productId);

    if (productIndex !== -1) {
        cart.splice(productIndex, 1); // Remove the item from the cart array
        renderCart(); // Update the UI to reflect changes
    } else {
        console.error(`Product with ID ${productId} not found in the cart.`);
    }
}
function removeFromCart(productId) {
    fetch(`/api/cart/${productId}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Failed to delete cart item: ${response.status}`);
        }
        // Remove item from local cart array
        cart = cart.filter(item => item.id !== productId);
        renderCart(); // Re-render the cart
    })
    .catch(error => {
        console.error('Error deleting cart item:', error);
        alert('Failed to remove item from cart. Please try again.');
    });
}
//////////////////////////////////////////////////////////////////////////////


// Checkout functionality
document.getElementById('checkout-button').addEventListener('click', async function () {
    if (cart.length === 0) {
        alert('Your cart is empty!');
        return;
    }

    try {
        const orderItems = cart.map(item => ({
            productId: item.id,
            quantity: item.quantity,
            price: item.price
        }));

        const response = await fetch('/api/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: orderItems })
        });

        if (!response.ok) {
            throw new Error(`Order placement failed: ${response.status}`);
        }

        const orderResult = await response.json();
        alert(`Order placed successfully! Order ID: ${orderResult.orderId}`);

        cart = []; // Clear the cart
        renderCart();

        for (const item of orderItems) {
            await updateProductQuantity(item.productId, item.quantity);
        }
    } catch (error) {
        console.error('Checkout error:', error);
        alert('Failed to complete the checkout. Please try again.');
    }
});

// Function to update product quantities in the backend
async function updateProductQuantity(productId, quantity) {
    try {
        const response = await fetch(`/api/products/${productId}/update-quantity`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ quantity })
        });

        if (!response.ok) {
            throw new Error(`Failed to update product quantity: ${response.status}`);
        }

        console.log(`Quantity updated for product ID ${productId}`);
    } catch (error) {
        console.error('Error updating product quantity:', error);
        alert('Failed to update product quantities. Please check with the administrator.');
    }
}

// Initialize the cart rendering and fetch backend cart items on page load
document.addEventListener('DOMContentLoaded', () => {
    fetchCartItems();
    renderCart();
});

    </script>
</body>
</html>
